---
title: 简化代码的小技巧
date: 2020-04-30 15:58:07
category: Java
tags:
  - Java
permalink: /pages/7a37a4/
categories:
  - 历史文章
author:
  name: itlaonong
  link: https://github.com/itlaonong
---

今天重构之前写的一段对账代码，基本逻辑是先校验，然后更新一下记录状态，然后处理对账主体的数据修改。抽象出来就是要三步，每一步出错或者校验不通过，就返回错误信息。
现在记录下过程。

<!-- more -->

抽象代码如下

```java
public class Check{
    public boolean first(Map<String,String> message){
        ...
        //出错或者校验不通过返回false，同时将错误信息保存到message中。
        ...
        return true;
    }

    public boolean second(Map<String,String> message){
        ...
        //出错或者校验不通过返回false，同时将错误信息保存到message中。
        ...
        return true;
    }

    public boolean last(Map<String,String> message){
        ...
        //出错或者校验不通过返回false，同时将错误信息保存到message中。
        ...
        return true;
    }
}
```

<!-- more -->

## 最直接写法

如果不考虑其他，第一反应肯定是这么写

```java
public class Test{

    public static void main(String[] args){
        Check check = new Check();
        Map<String,String> message = new HashMap<>();
        if(check.first(message)){
            if(check.second(message)){
                if(check.last(message)){
                   //commit;
                }else{
                   //rollback;
                }
            } else{
                //rollback;
            }
        }else{
            //rollback;
        }
        System.out.println(message.get("msg"));
    }
}
```

没错，项目中的代码就是这么写的，多层 if 嵌套，抽象出来还能看懂，添加上大段的业务逻辑，看起来就费劲了。

## 第一步优化

先来第一步优化，把多层 if 嵌套去掉。

```java
public class Test{

    public static void main(String[] args){
        Check check = new Check();
        Map<String,String> message = new HashMap<>();
        if(!check.first(message)){
            System.out.println(message.get("msg"));
            //rollback;
            return;
        }
        if(!check.second(message)){
            System.out.println(message.get("msg"));
            //rollback;
            return;
        }
        if(!check.last(message)){
            System.out.println(message.get("msg"));
            //rollback;
            return;
        }
        //commit;
    }
}
```

通过 return 提前返回，避免多层 if 嵌套。

## 再次精简

我觉得写代码能有上面的觉悟已经不错了。不过无意中发现还有更简单的，但是好像不容易理解。代码如下：

```java
public class Test{

    public static void main(String[] args){
        Check check = new Check();
        Map<String,String> message = new HashMap<>();
        if(!check.first(message) || !check.second(message) || !check.last(message)){
            System.out.println(message.get("msg"));
            //rollback;
            return;
        }
        //commit;
    }
}
```

利用判断条件的或，合并代码。原理是或判断如果前面的条件为真，就不再判断后面的条件。也就是前面如果报错，取反为真，则不判断后面的条件，直接进入 if 条件里面，也就不执行后面的代码而直接返回错误信息。只有当所有的操作都不报错，才会到最后的 commit 操作。
