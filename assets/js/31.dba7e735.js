(window.webpackJsonp=window.webpackJsonp||[]).push([[31],{514:function(a,e,s){"use strict";s.r(e);var t=s(31),r=Object(t.a)({},(function(){var a=this,e=a.$createElement,s=a._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"apache-james-使用-mysql-存储启动报错-specified-key-was-too-long-max-key-length-is-3072-bytes"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#apache-james-使用-mysql-存储启动报错-specified-key-was-too-long-max-key-length-is-3072-bytes"}},[a._v("#")]),a._v(" Apache James 使用 mysql 存储启动报错 Specified key was too long; max key length is 3072 bytes")]),a._v(" "),s("p",[a._v("没事捣鼓自建 mail 服务，作为 java 开发，肯定想到了 java 实现。刚好 apache 就有开源的"),s("a",{attrs:{href:"http://james.apache.org/index.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("James（Java Apache Mail Enterprise Server）"),s("OutboundLink")],1),a._v("。"),s("a",{attrs:{href:"http://james.apache.org/download.cgi",target:"_blank",rel:"noopener noreferrer"}},[a._v("下载"),s("OutboundLink")],1),a._v("下来准备试试。")]),a._v(" "),s("p",[a._v("目前最新版是 3.4.0 版本。")]),a._v(" "),s("p",[a._v("下载完成后网上找到"),s("a",{attrs:{href:"https://blog.csdn.net/hjnth/article/details/82931569",target:"_blank",rel:"noopener noreferrer"}},[a._v("教程"),s("OutboundLink")],1),a._v("进行配置。")]),a._v(" "),s("p",[a._v("因为针对 mysql 报错的问题。只记录数据源配置点。")]),a._v(" "),s("h2",{attrs:{id:"修改数据源"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#修改数据源"}},[a._v("#")]),a._v(" 修改数据源")]),a._v(" "),s("p",[a._v("修改 conf/james-database.properties 中")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("# Use derby as default\n# database.driverClassName=org.apache.derby.jdbc.EmbeddedDriver\n# database.url=jdbc:derby:../var/store/derby;create=true\n# database.username=app\n# database.password=app\ndatabase.driverClassName=com.mysql.jdbc.Driver\ndatabase.url=jdbc:mysql://127.0.0.1:3306/james?rewriteBatchedStatements=true&useUnicode=true&characterEncoding=utf8\ndatabase.username=james#账密自行修改即可\ndatabase.password=james\n\n# Supported adapters are:\n# DB2, DERBY, H2, HSQL, INFORMIX, MYSQL, ORACLE, POSTGRESQL, SQL_SERVER, SYBASE\n# vendorAdapter.database=DERBY\nvendorAdapter.database=MYSQL\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br"),s("span",{staticClass:"line-number"},[a._v("14")]),s("br")])]),s("p",[a._v("因为教程中提示可能会报错，我提前在数据库中执行了下面脚本。")]),a._v(" "),s("div",{staticClass:"language-sql line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("SET")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("GLOBAL")]),a._v(" innodb_file_format "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" BARRACUDA"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("SET")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("GLOBAL")]),a._v(" innodb_large_prefix "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("ON")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("h2",{attrs:{id:"报错"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#报错"}},[a._v("#")]),a._v(" 报错")]),a._v(" "),s("p",[a._v("在 bin 目录下执行"),s("code",[a._v("run.bat")]),a._v("(win10)。")]),a._v(" "),s("p",[a._v("启动报错。")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("org.apache.openjpa.persistence.PersistenceException: Specified key was too long; max key length is 3072 bytes {stmnt 2076356118 CREATE TABLE JAMES_MAIL_REPOS (MAIL_REPO_NAME VARCHAR(1024) NOT NULL, PRIMARY KEY (MAIL_REPO_NAME)) ENGINE = innodb} [code=1071, state=42000]\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("h2",{attrs:{id:"分析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#分析"}},[a._v("#")]),a._v(" 分析")]),a._v(" "),s("p",[a._v("这个问题和教程中提到的类似，网上查找是 MySQL 主键索引长度不够。")]),a._v(" "),s("p",[a._v("找到很多资料后得知：mysql 默认索引长度最大长度是 767bytes，如果是"),s("a",{attrs:{href:"https://blog.csdn.net/wjxbj/article/details/84737812",target:"_blank",rel:"noopener noreferrer"}},[a._v("utf8 编码（MySQL 的 utf8 编码最长 3byte）"),s("OutboundLink")],1),a._v("。只能用 varchar(255)。开启"),s("code",[a._v("innodb_large_prefix=on")]),a._v("后索引长度最大长度是 3072bytes，如果是 utf8 编码。应该能用 varchar(1024)。而日志中的 sql 显示字段长度为 1024。理论上不应该报错。")]),a._v(" "),s("h2",{attrs:{id:"解决"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#解决"}},[a._v("#")]),a._v(" 解决")]),a._v(" "),s("p",[a._v("问题就在这编码上，按照上面的逻辑，字段长度乘以编码最大字节长度小于等于 3072 就可以。但是我使用的 utf8mb4 编码（MySQL 独有的，最长 4byte）。所以 varchar(1024)最长就是 4096>3074。我删除原来的数据库，以 utf8 重新创建，启动不再报错。")]),a._v(" "),s("p",[a._v("这里要吐槽一下，其实 uft8 编码字符理论上可以最多到 6 个字节长，通常 uft8 使用 1~4 字节为每个字符编码（utf8 是变长编码-霍夫曼编码）。但是 MySQL 最开始支持 utf8 的时候只做了最长 3 个字节（MySQL 中的 uft8）。后面为了兼容 4 个字节，又增加了 uft8mb4（旧版本没有）。所以其实 MySQL 中 utf8mb4 才是真正的 utf8。之前公司项目中为了支持 emoji 表情（4 字节 utf8 编码），了解过 MySQL 的这段编码故事，所以 MySQL 中喜欢使用 utf8mb4。结果就遇到了这个坑爹的问题。")])])}),[],!1,null,null,null);e.default=r.exports}}]);